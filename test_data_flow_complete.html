<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usage Type Data Flow Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .success {
            border-color: #28a745;
            background: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .warning {
            border-color: #ffc107;
            background: #fff3cd;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .chart-preview {
            width: 100%;
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .bar {
            height: 20px;
            background: #007bff;
            border-radius: 3px;
            transition: width 0.3s;
        }
        .bar-container {
            width: 100%;
            background: #e9ecef;
            border-radius: 3px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Usage Type Data Flow Test</h1>
        <p>This page tests the complete data flow from CSV to chart rendering.</p>
    </div>

    <div class="container">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <div class="container">
        <h2>Visual Preview</h2>
        <div id="chart-preview" class="chart-preview">
            <p>Chart preview will appear here...</p>
        </div>
    </div>

    <script type="module">
        // Import Papa Parse for CSV parsing
        import Papa from 'https://cdn.skypack.dev/papaparse';

        const resultsDiv = document.getElementById('results');
        const chartPreview = document.getElementById('chart-preview');

        function addStep(title, content, status = 'info') {
            const step = document.createElement('div');
            step.className = `step ${status}`;
            step.innerHTML = `
                <h3>${title}</h3>
                <div>${content}</div>
            `;
            resultsDiv.appendChild(step);
        }

        async function testDataFlow() {
            try {
                // Step 1: Fetch CSV
                addStep('Step 1: Fetching CSV', 'Loading /ahrq_reference_good.csv...');
                
                const response = await fetch('/ahrq_reference_good.csv');
                if (!response.ok) {
                    throw new Error(`Failed to fetch CSV: ${response.status}`);
                }
                
                const csvText = await response.text();
                addStep('CSV Loaded', `Loaded ${csvText.length} characters`, 'success');

                // Step 2: Parse CSV
                addStep('Step 2: Parsing CSV', 'Using Papa Parse...');
                
                const parseResult = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: (header) => {
                        return header.replace(/^\uFEFF/, '').replace(/['"]/g, '').trim();
                    }
                });

                const publications = parseResult.data;
                addStep('CSV Parsed', `Found ${publications.length} publications`, 'success');

                // Step 3: Check Usage Types
                addStep('Step 3: Analyzing Usage Types', 'Counting usage type distribution...');
                
                const usageCounts = {};
                const samplePubs = [];
                
                publications.forEach((pub, index) => {
                    const usage = pub.Usage_Type || 'UNKNOWN';
                    usageCounts[usage] = (usageCounts[usage] || 0) + 1;
                    
                    if (index < 5) {
                        samplePubs.push({
                            title: pub.Title?.substring(0, 50) + '...',
                            usage: usage
                        });
                    }
                });

                let sampleTable = '<table><tr><th>Title</th><th>Usage Type</th></tr>';
                samplePubs.forEach(pub => {
                    sampleTable += `<tr><td>${pub.title}</td><td>${pub.usage}</td></tr>`;
                });
                sampleTable += '</table>';

                addStep('Sample Publications', sampleTable, 'success');

                // Step 4: Compute Distribution
                addStep('Step 4: Computing Distribution', 'Transforming data for charts...');
                
                const usageData = Object.entries(usageCounts).map(([type, count]) => ({
                    name: type.replace(/_/g, ' ').toLowerCase()
                        .replace(/\b\w/g, l => l.toUpperCase()),
                    value: count,
                    percentage: Math.round((count / publications.length) * 100)
                }));

                let distributionTable = '<table><tr><th>Usage Type</th><th>Count</th><th>Percentage</th></tr>';
                usageData.forEach(item => {
                    distributionTable += `<tr><td>${item.name}</td><td>${item.value}</td><td>${item.percentage}%</td></tr>`;
                });
                distributionTable += '</table>';

                addStep('Usage Distribution', distributionTable, 'success');

                // Step 5: Simulate Chart Data
                addStep('Step 5: Preparing Chart Data', 'Adding colors and formatting...');
                
                const colors = ['#3B82F6', '#10B981', '#F59E0B'];
                const chartData = usageData.map((u, i) => ({
                    ...u,
                    color: colors[i] || '#6B7280'
                }));

                addStep('Chart Data Ready', `<pre>${JSON.stringify(chartData, null, 2)}</pre>`, 'success');

                // Step 6: Create Simple Bar Chart
                createSimpleBarChart(chartData);

                // Check for issues
                if (usageData.length === 0) {
                    addStep('Warning', 'No usage data found!', 'warning');
                } else if (usageData.some(d => d.value === 0)) {
                    addStep('Warning', 'Some usage types have zero count', 'warning');
                }

            } catch (error) {
                addStep('Error', `<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
        }

        function createSimpleBarChart(data) {
            chartPreview.innerHTML = '';
            
            const maxValue = Math.max(...data.map(d => d.value));
            
            const chartHtml = `
                <div style="width: 100%; padding: 20px;">
                    <h3 style="text-align: center; margin-bottom: 20px;">Usage Type Distribution</h3>
                    ${data.map(item => `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600;">${item.name}</span>
                                <span>${item.value} (${item.percentage}%)</span>
                            </div>
                            <div class="bar-container">
                                <div class="bar" style="width: ${(item.value / maxValue) * 100}%; background: ${item.color};"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            chartPreview.innerHTML = chartHtml;
        }

        // Run the test
        testDataFlow();
    </script>
</body>
</html>